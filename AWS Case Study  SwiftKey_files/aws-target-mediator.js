/*!
 * aws-target-mediator.js 
 *
 * Copyright 2014, Amazon.com, Inc. or its affiliates. All rights reserved.
 */
!function(){var Util={generateRandomId:function(){return(new Date).getTime()+"-"+Math.floor(Math.random()*999999)},getQueryStringParameterByName:function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var re=new RegExp("[\\?&]"+name+"=([^&#]*)");var res=re.exec(window.location.search);if(res===null){return""}else{return decodeURIComponent(res[1].replace(/\+/g," "))}},hasCORSSupport:function(){return"withCredentials"in new XMLHttpRequest}};function consoleDebug(message){if(TargetMediator.debug===true){console.log("TargetMediator: "+message)}}var TargetError=function(){function TargetError(message){var err=new Error(message);err.name="TargetError";this.message=err.message;if(err.stack){this.stack=err.stack}}var err=new Error;err.name="TargetError";TargetError.prototype=err;return TargetError}();var Logger=function(){var logs=[];function Logger(){if(Logger.prototype._singletonInstance){return Logger.prototype._singletonInstance}else{Logger.prototype._singletonInstance=this}}Logger.prototype={log:function(obj){switch(obj.type){case"TargetRequesterXHRSuccess":break;case"TargetRequesterXHRError":break;case"TargetRequesterTimeoutError":break;case"TargetRequesterParameterError":break;case"InvalidOfferError":break;case"UnassociatedOfferError":break;case"UnparsableOfferError":break;case"DuplicateOfferError":break;case"AWSRequesterXHRSuccess":break;case"AWSRequesterXHRError":break;case"AWSRequesterTimeoutError":break;case"OfferInjectionError":break;default:throw new TargetError("LoggerError: Unknown log type: "+obj.type)}var currentTime=null;if("currentTime"in obj){currentTime=obj.currentTime}else{currentTime=(new Date).getTime()}obj.namespace="TargetMediator";obj.time=currentTime;obj.elapsedPageTime=this.getElapsedTimeSinceScriptLoad(currentTime);obj.isFirstTimeVisitor=+TargetMediator.isFirstTimeVisitor;obj.isLiveUrl=+this.isLiveUrl();obj.page=document.location.toString();if("requestStartTime"in obj){obj.requestTime=currentTime-obj.requestStartTime}else{obj.requestTime="X"}if("isClickRequest"in obj){obj.isClickRequest=+obj.isClickRequest}else{obj.isClickRequest=0}logs.push(obj);var json=JSON.stringify(obj);consoleDebug(json);obj.page=obj.page.replace(/^https?:\/\/.*amazon\.com/,"");obj.page=obj.page.replace(/(\?|\#).*$/,"");if(obj.page===""){obj.page="/"}if(obj.type.match(/^AWSRequester/)){if(obj.data.substr(obj.data.length-1,1)==="/"){obj.data=obj.data.substr(0,obj.data.length-1)}var lastSlash=obj.data.lastIndexOf("/");if(lastSlash!==-1){obj.data=obj.data.substring(lastSlash+1)}}var logExternally=true;if(!obj.isLiveUrl){logExternally=false}var hour=(new Date).getHours();if(hour%2===0){logExternally=false}var arrReportable=[obj.type,obj.elapsedPageTime,obj.requestTime,obj.isFirstTimeVisitor,obj.isLiveUrl,obj.isClickRequest,obj.page,obj.data];var reportable=arrReportable.join("|");var startTime=(new Date).getTime();var maxTimeout=1e4;var pollToReport=function(){try{if(typeof aws_sc==="object"&&aws_sc.eventReport){if(logExternally){aws_sc.eventReport(reportable)}else{consoleDebug("External logging is disabled for this time or environment.")}return}}catch(ex){consoleDebug("UnreportableError: Logging failed: "+ex.message)}if((new Date).getTime()-startTime>maxTimeout){consoleDebug("Failed to send log: "+reportable);return}setTimeout(function(){pollToReport()},500)};pollToReport()},getLastLog:function(){return logs[logs.length-1]},getElapsedTimeSinceScriptLoad:function(currentTime){currentTime=currentTime||(new Date).getTime();return currentTime-TargetMediator.scriptLoadTime},isLiveUrl:function(){var re=/^https?:\/\/aws\.amazon\.com/g;var res=re.exec(document.location.toString());if(res===null){return false}else{return true}}};return Logger}();var TargetRequestDataBuilder=function(){function TargetRequestDataBuilder(mboxParams,pageParams){this.mboxParams=mboxParams;this.pageParams=pageParams;this.postParams=null;this.clientCode="amazonwebservicesinc";this.url="http://amazonwebservicesinc.tt.omtrdc.net/m2/"+this.clientCode+"/ubox/raw";this.url=this.replaceUrlProtocolWithCurrent(this.url)}TargetRequestDataBuilder.prototype={build:function(){this.postParams={};for(var key in this.pageParams){if(this.pageParams.hasOwnProperty(key)){this.postParams[key]=this.pageParams[key]}}for(key in this.mboxParams){if(this.mboxParams.hasOwnProperty(key)){this.postParams[key]=this.mboxParams[key]}}this.url=this.url+"?"+this.makeQueryString({mboxPC:this.postParams.mboxPC,mboxSession:this.postParams.mboxSession,uniq:this.postParams.mboxRequestId})},makeQueryString:function(params){var parts=[];for(var key in params){if(params.hasOwnProperty(key)){parts.push(encodeURIComponent(key)+"="+encodeURIComponent(params[key]))}}return parts.join("&")},replaceUrlProtocolWithCurrent:function(url){var re=/^https?/g;return url.replace(re,document.location.toString().match(re)[0])}};return TargetRequestDataBuilder}();var CookieManager=function(){function CookieManager(name){this.name=name;this.exists=false;this.rawValue=null;this.value=null;this.expireSeconds=86400;if(document.cookie.length&&document.cookie.indexOf(this.name)!==-1){this.exists=true}}CookieManager.prototype={read:function(){var found=false;if(document.cookie.length){var cookieStart=document.cookie.indexOf(this.name);if(cookieStart!==-1){found=true;var valueStart=cookieStart+this.name.length+1;var cookieEnd=document.cookie.indexOf(";",valueStart);if(cookieEnd===-1){cookieEnd=document.cookie.length}this.rawValue=document.cookie.substring(valueStart,cookieEnd)}}if(!found){this.exists=false}},write:function(){var options={};options.value=this.name+"="+this.rawValue;var expiresDate=new Date;expiresDate.setSeconds(expiresDate.getSeconds()+this.expireSeconds);options.expires="; expires="+expiresDate.toUTCString();options.path="; path=/";var hostname=document.location.hostname;var periodCount=hostname.split(".").length-1;if(periodCount>2){var lastIndex=0;var unneededPeriods=periodCount-2;for(var i=0,len=unneededPeriods;i<len;i++){lastIndex=hostname.indexOf(".",lastIndex+1)}hostname=hostname.substring(lastIndex+1)}hostname=hostname==="localhost"?"":hostname;options.domain="; domain="+hostname;document.cookie=[options.value,options.expires,options.path,options.domain].join("");this.exists=true},encode:function(){this.rawValue=encodeURIComponent(this.value)},decode:function(){try{this.value=decodeURIComponent(this.rawValue)}catch(ex){throw new TargetError("CookieError: Failed to decode cookie "+this.name)}}};return CookieManager}();var ParameterFetcher=function(){function ParameterFetcher(){this.mboxPageId=null;this.mboxXDomain=null;this.mboxNoRedirect=null;this.mboxHost=null;this.screenWidth=null;this.screenHeight=null;this.screenColorDepth=null;this.browserWidth=null;this.browserHeight=null;this.browserTimeOffset=null;this.currentUrl=null;this.referringUrl=null;this.registrationCookie=new CookieManager("regStatus");this.awsXMainCookie=new CookieManager("aws-x-main");this.sessionCookie=new CookieManager("aws-target-session-id");this.visitorCookie=new CookieManager("aws-target-visitor-id")}ParameterFetcher.prototype={init:function(){this.mboxPageId=this.generateMboxPageId();this.mboxXDomain=this.getMboxXDomain();this.mboxNoRedirect=this.getMboxNoRedirect();this.mboxHost=this.getMboxHost();this.screenWidth=this.getScreenWidth();this.screenHeight=this.getScreenHeight();this.screenColorDepth=this.getScreenColorDepth();this.browserWidth=this.getBrowserWidth();this.browserHeight=this.getBrowserHeight();this.browserTimeOffset=this.getBrowserTimeOffset();this.currentUrl=this.getCurrentUrl();this.referringUrl=this.getReferringUrl();this.registrationStatus=this.getRegistrationStatus();this.hasAWSXMain=this.hasAWSXMainCookie();this.sessionCookie.read();this.getSessionId();this.visitorCookie.read();this.getVisitorId()},allParams:function(){return{mboxPC:this.mboxPCId,mboxSession:this.mboxSessionId,mboxPage:this.mboxPageId,mboxXDomain:this.mboxXDomain,mboxNoRedirect:this.mboxNoRedirect,mboxHost:this.mboxHost,screenWidth:this.screenWidth,screenHeight:this.screenHeight,colorDepth:this.screenColorDepth,browserWidth:this.browserWidth,browserHeight:this.browserHeight,browserTimeOffset:this.browserTimeOffset,mboxUrl:this.currentUrl,mboxReferrer:this.referringUrl,registrationStatus:this.registrationStatus,hasAWSXMain:this.hasAWSXMain}},generateMboxPCId:function(){return Util.generateRandomId()},generateMboxSessionId:function(){return Util.generateRandomId()},generateMboxPageId:function(){return Util.generateRandomId()},getMboxXDomain:function(){return"disabled"},getMboxNoRedirect:function(){return 1},getScreenWidth:function(){return screen.width},getScreenHeight:function(){return screen.height},getScreenColorDepth:function(){return screen.pixelDepth},getBrowserWidth:function(){return window.innerWidth?window.innerWidth:document.documentElement?document.documentElement.clientWidth:document.body.clientWidth},getBrowserHeight:function(){return window.innerHeight?window.innerHeight:document.documentElement?document.documentElement.clientHeight:document.body.clientHeight},getBrowserTimeOffset:function(){return-(new Date).getTimezoneOffset()},getCurrentUrl:function(){return document.location.toString()},getReferringUrl:function(){var referringUrl=document.referrer;if(referringUrl.length<2e3){return referringUrl}else{return""}},getMboxHost:function(){return document.location.hostname},getSessionId:function(){var isSessionCookieInvalid=false;if(this.sessionCookie.exists){try{this.sessionCookie.decode();this.mboxSessionId=this.sessionCookie.value}catch(ex){consoleDebug(ex.message);isSessionCookieInvalid=true}}else{consoleDebug("Cookie "+this.sessionCookie.name+" does not exist yet so create it");isSessionCookieInvalid=true}if(isSessionCookieInvalid){this.mboxSessionId=this.generateMboxSessionId();this.sessionCookie.value=this.mboxSessionId}this.sessionCookie.expireSeconds=1800;this.sessionCookie.encode();this.sessionCookie.write()},getVisitorId:function(){var isVisitorCookieInvalid=false;if(this.visitorCookie.exists){try{this.visitorCookie.decode();this.mboxPCId=this.visitorCookie.value}catch(ex){consoleDebug(ex.message);isVisitorCookieInvalid=true}}else{consoleDebug("Cookie "+this.visitorCookie.name+" does not exist yet so create it");isVisitorCookieInvalid=true}if(isVisitorCookieInvalid){this.mboxPCId=this.generateMboxPCId();this.visitorCookie.value=this.mboxPCId;TargetMediator.isFirstTimeVisitor=true}this.visitorCookie.expireSeconds=33696e3;this.visitorCookie.encode();this.visitorCookie.write()},getRegistrationStatus:function(){if(this.registrationCookie.exists){this.registrationCookie.read();var value=this.registrationCookie.rawValue;if(value==="registered"||value==="registering"){return value}}return"unregistered"},hasAWSXMainCookie:function(){return this.awsXMainCookie.exists.toString()}};return ParameterFetcher}();var TargetRequester=function(){var offerRegistry={};function TargetRequester(callback,targetRequestDataBuilder,logger,isClickRequest){this.callback=callback;this.url=targetRequestDataBuilder.url;this.postData=targetRequestDataBuilder.postParams;this.logger=logger;this.isClickRequest=isClickRequest;this.rawData=null;this.data=null;this.state="pending";this.maxTimeout=6e3}TargetRequester.prototype={fetch:function(){var that=this;this.requestStartTime=(new Date).getTime();var pr=$.ajax({type:"POST",url:this.url,data:this.postData,crossDomain:true,xhrFields:{withCredentials:false}}).done(function(data,textStatus,jqXHR){that.done.call(that,data,textStatus,jqXHR)}).fail(function(data,textStatus,jqXHR){that.fail.call(that,data,textStatus,jqXHR)});var pollForResponse=function(){if(pr.state()!=="pending"){return}var currentTime=(new Date).getTime();if(currentTime-that.requestStartTime>=that.maxTimeout){that.state="timeout";pr.abort();return}var nextValue;setTimeout(nextValue=function(){return pollForResponse()},100);return nextValue};pollForResponse()},done:function(data,textStatus,jqXHR){this.rawData=data;consoleDebug("TargetRequester success for "+this.postData.mbox+" returned: "+this.rawData);this.logger.log({type:"TargetRequesterXHRSuccess",data:this.postData.mbox,requestStartTime:this.requestStartTime,isClickRequest:this.isClickRequest,currentTime:(new Date).getTime()});this.validateResponseData(this.rawData);this.callback(this.response,this.state)},fail:function(data,textStatus,jqXHR){if(this.state==="timeout"){this.logger.log({type:"TargetRequesterTimeoutError",data:this.postData.mbox,requestStartTime:this.requestStartTime,isClickRequest:this.isClickRequest,currentTime:(new Date).getTime()})}else{this.logger.log({type:"TargetRequesterXHRError",data:this.postData.mbox,requestStartTime:this.requestStartTime,isClickRequest:this.isClickRequest,currentTime:(new Date).getTime()})}this.state="rejected";this.callback(this.rawData,this.state)},validateResponseData:function(raw){if(this.isClickRequest){this.state="resolved"}else if(this.isUnassociatedOffer(raw)){this.logger.log({type:"UnassociatedOfferError",data:this.postData.mbox,isClickRequest:this.isClickRequest});this.state="rejected"}else if(this.isValidDefaultOffer(raw)){try{this.parseResponseData(raw);this.state="resolved"}catch(ex){this.logger.log({type:"UnparsableOfferError",data:this.postData.mbox,isClickRequest:this.isClickRequest});this.state="rejected"}}else if(this.isErrorOffer(raw)){this.logger.log({type:"TargetRequesterParameterError",data:this.postData.mbox,isClickRequest:this.isClickRequest});this.state="rejected"}else if(this.isValidRegularOffer(raw)){try{this.parseResponseData(raw);if(this.isDuplicateOffer()){this.logger.log({type:"DuplicateOfferError",data:this.postData.mbox,isClickRequest:this.isClickRequest});this.state="rejected"}else{offerRegistry[this.response.url]=true;this.state="resolved"}}catch(ex){this.logger.log({type:"UnparsableOfferError",data:this.postData.mbox,isClickRequest:this.isClickRequest});this.state="rejected"}}else{this.logger.log({type:"InvalidOfferError",data:this.postData.mbox,isClickRequest:this.isClickRequest});this.state="rejected"}},isUnassociatedOffer:function(raw){return raw==="success"},isDefaultOffer:function(raw){return raw==="default offer"},isErrorOffer:function(raw){var re=/^Mbox parameter \'(mbox|mboxTarget)\' not specified$/g;var res=re.exec(raw);if(res===null){return false}else{return true}},isDuplicateOffer:function(){return this.response.url in offerRegistry},isValidDefaultOffer:function(raw){var re=/^\{"defaultOffer":true,"campaignId":"[0-9]{1,40}","environmentId":"[0-9]{1,40}","userPCId":"[0-9\.\-_]{10,30}"\}$/g;var res=re.exec(raw);if(res===null){return false}else{return true}},isValidRegularOffer:function(raw){var re=/^\{"url":"https?:\/\/aws\.amazon\.com\/[a-zA-Z0-9\/_\.\-%\+\,\'\?\\#\$\&]*","campaignId":"[0-9]{1,40}","environmentId":"[0-9]{1,40}","userPCId":"[0-9\.\-_]{10,30}"\}$/g;var res=re.exec(raw);if(res===null){return false}else{return true}},parseResponseData:function(raw){this.response=$.parseJSON(raw)}};return TargetRequester}();var AWSRequester=function(){function AWSRequester(callback,logger){this.callback=callback;this.logger=logger;this.data=null;this.status="pending";this.maxTimeout=4e3}AWSRequester.prototype={fetch:function(){var that=this;this.requestStartTime=(new Date).getTime();var pr=$.ajax({type:"GET",url:this.url}).done(function(data,textStatus,jqXHR){that.done.call(that,data,textStatus,jqXHR)}).fail(function(data,textStatus,jqXHR){that.fail.call(that,data,textStatus,jqXHR)});var pollForResponse=function(){if(pr.state()!=="pending"){return}var currentTime=(new Date).getTime();if(currentTime-that.requestStartTime>=that.maxTimeout){that.state="timeout";pr.abort();return}var nextValue;setTimeout(nextValue=function(){return pollForResponse()},100);return nextValue};pollForResponse()},done:function(data,textStatus,jqXHR){this.data=data;consoleDebug("AWSRequester success for "+this.url);this.logger.log({type:"AWSRequesterXHRSuccess",data:this.url,requestStartTime:this.requestStartTime,currentTime:(new Date).getTime()});this.state="resolved";this.callback(this.data,this.state)},fail:function(data,textStatus,jqXHR){if(this.state==="timeout"){this.logger.log({type:"AWSRequesterTimeoutError",data:this.url,requestStartTime:this.requestStartTime,currentTime:(new Date).getTime()})}else{this.logger.log({type:"AWSRequesterXHRError",data:this.url,requestStartTime:this.requestStartTime,currentTime:(new Date).getTime()})}this.state="rejected";this.callback(this.data,this.state)},setUrl:function(url){if(document.location.toString().match(/^https?:\/\/aws\.amazon\.com/g)){url=this.replaceUrlProtocolWithCurrent(url)}else{url=this.replaceUrlOriginWithCurrent(url)}url=this.appendUrlFileSuffix(url);url=this.appendUrlQueryString(url);url=this.prependUrlPathname(url);this.url=url},replaceUrlOriginWithCurrent:function(url){var origin=window.location.protocol+"//"+window.location.host;var re=/^https?:\/\/([a-z]*\.)?aws\.amazon\.com/g;return url.replace(re,origin)},replaceUrlProtocolWithCurrent:function(url){var re=/^https?/g;return url.replace(re,document.location.toString().match(re)[0])},appendUrlFileSuffix:function(url){if(url.match(/\/$/g)){if(TargetMediator.offerFileSuffix==="/"){return url}else{return url.substr(0,url.length-1)+TargetMediator.offerFileSuffix}}else{return url+TargetMediator.offerFileSuffix}},appendUrlQueryString:function(url){return url+TargetMediator.offerQueryString},prependUrlPathname:function(url){if(TargetMediator.offerContentPath!==""){var indexOfProtocolEnd=url.indexOf("//");var indexOfPathname=url.indexOf("/",indexOfProtocolEnd+2);return url.substr(0,indexOfPathname)+TargetMediator.offerContentPath+url.substr(indexOfPathname,url.length)}return url}};return AWSRequester}();var Mbox=function(){function Mbox($elem,logger){this.$elem=$elem;this.logger=logger;this.name=this.getName($elem);TargetMediator.mboxRegistry[this.name]={state:"pending"};this.time=this.getMboxTime();this.requestId=this.generateMboxRequestId();consoleDebug("Instantiate mbox "+this.name+" at time "+(new Date).getTime()+"; "+((new Date).getTime()-TargetMediator.scriptLoadTime)+"ms elapsed")}Mbox.prototype={init:function(){this.targetRequestDataBuilder=new TargetRequestDataBuilder(this.allParams(),TargetMediator.pageParams);this.targetRequestDataBuilder.build();this.targetRequester=new TargetRequester($.proxy(this.handleOfferResponse,this),this.targetRequestDataBuilder,this.logger,false);this.awsRequester=new AWSRequester($.proxy(this.handleContentResponse,this),this.logger);this.targetRequester.fetch()},handleOfferResponse:function(response,state){if(state==="resolved"){this.updateVisitorId(response);this.mboxTarget=this.buildMboxTarget(response)}if(state==="resolved"&&typeof response.defaultOffer==="undefined"){this.awsRequester.setUrl(response.url);this.awsRequester.fetch()}else if(state==="resolved"&&typeof response.defaultOffer==="boolean"&&response.defaultOffer){this.showDefault();this.setClickHandler()}else{this.showDefault()}},handleContentResponse:function(response,state){if(state==="resolved"){var contentInjectionFailed=false;var $defaultElem=this.$elem.clone();try{this.$elem.html(response)}catch(ex){contentInjectionFailed=true;this.$elem.html($defaultElem.html());this.showDefault();this.logger.log({type:"OfferInjectionError",data:this.name,message:ex.name+": "+ex.message});throw new TargetError("OfferInjectionError: "+ex.name+": "+ex.message)}if(!contentInjectionFailed){this.showOffer();this.setClickHandler()}}else{this.showDefault()}},handleClickResponse:function(response,state){if("clickUrl"in this){consoleDebug("Go to click url "+this.clickUrl);window.location=this.clickUrl}},setClickHandler:function(){var that=this;this.$elem.on("click",function(e){consoleDebug("Clicked "+that.name);var mboxParams={mbox:that.name+"-clicked",mboxTime:that.getMboxTime(),mboxRequestId:that.generateMboxRequestId(),mboxTarget:that.mboxTarget};var targetRequestDataBuilder=new TargetRequestDataBuilder(mboxParams,TargetMediator.pageParams);targetRequestDataBuilder.build();var $closestAnchor=$(e.target).closest("a");var isClosestAnchorWithinMbox=!!$closestAnchor.parents(".js-mbox").length;if(isClosestAnchorWithinMbox){that.clickUrl=$closestAnchor.attr("href");if(typeof that.clickUrl!=="undefined"&&that.clickUrl!==""&&that.clickUrl.match(/^(\#|javascript)/)===null){e.preventDefault();var targetRequester=new TargetRequester($.proxy(that.handleClickResponse,that),targetRequestDataBuilder,that.logger,true);targetRequester.fetch()}}})},getName:function($mbox){var name=$mbox.attr("data-mbox");if(typeof name==="undefined"){this.showDefault();throw new TargetError("MboxNameError: Data attribute is undefined")}else if(name.length>250){this.showDefault();throw new TargetError("MboxNameError: "+name+" exceeds max length of 250 characters")}else if(name.match(/\s+$/g)){this.showDefault();throw new TargetError("MboxNameError: "+name+" has trailing whitespace")}else if(!name.match(TargetMediator.supportedLangsRegExp)){this.showDefault();throw new TargetError("MboxNameError: "+name+" does not have a valid preceding locale code")}if(name.indexOf("en_")===0){name=name.substring(2,name.length);name=TargetMediator.supportedLangs[TargetMediator.pageLangCode]+name}else{if(name.indexOf(TargetMediator.supportedLangs[TargetMediator.pageLangCode]+"_")!==0&&TargetMediator.pageLangCode!=="ja-JP"){this.showDefault();throw new TargetError("MboxNameError: "+name+" is not in the current page language")}if(TargetMediator.pageLangCode==="ja-JP"&&name.indexOf("ja_")!==0&&name.indexOf("jp_")!==0){this.showDefault();throw new TargetError("MboxNameError: "+name+" is not in the current page language")}}if(name in TargetMediator.mboxRegistry){this.showDefault();throw new TargetError("MboxNameError: "+name+" is already registered in the current page")}return name},getMboxTime:function(){var now=new Date;return now.getTime()-now.getTimezoneOffset()*6e4},generateMboxRequestId:function(){return Util.generateRandomId()},buildMboxTarget:function(response){return response.campaignId+"."+response.environmentId},allParams:function(){return{mbox:this.name,mboxTime:this.time,mboxRequestId:this.requestId}},updateVisitorId:function(response){if(TargetMediator.pageParams.mboxPCId!==response.userPCId){TargetMediator.pageParams.mboxPCId=response.userPCId;var visitorCookie=new CookieManager("aws-target-visitor-id");visitorCookie.value=TargetMediator.pageParams.mboxPCId;visitorCookie.expireSeconds=33696e3;visitorCookie.encode();visitorCookie.write()}},showDefault:function(){this.show("default content")},showOffer:function(){this.show("offer")},show:function(offerType){if(typeof this.name!=="undefined"){TargetMediator.mboxRegistry[this.name].state="resolved"}if(TargetMediator.hasEncounteredLastMbox){TargetMediator.checkJqueryReadyHold()}this.$elem[0].style.visibility="visible";consoleDebug("Show "+offerType+" for "+this.name+" at time "+(new Date).getTime()+"; "+((new Date).getTime()-TargetMediator.scriptLoadTime)+"ms elapsed")}};return Mbox}();mboxCreate=function(){var locatorId="js-mbox-"+TargetMediator.locatorNodeCount++;consoleDebug("Create mbox locator "+locatorId);document.write('<div id="'+locatorId+'" style="visibility:hidden;display:none;">&nbsp;</div>');var locatorNode=document.getElementById(locatorId);var node=function(node){while(node!==null){if(node.nodeType===1){if((" "+node.className+" ").indexOf(" js-mbox ")>-1){return node}}node=node.previousSibling}return null}(locatorNode);if(node===null){document.write("<style>."+"js-mbox"+" { visibility:visible; }</style>");throw new TargetError("MboxCreateError: Failed to find an mbox at locator id "+locatorId)}var $elem=$(node);if($elem.length===0){document.write("<style>."+"js-mbox"+" { visibility:visible; }</style>");throw new TargetError("MboxCreateError: Failed to create a jQuery "+"object from mbox at locator id "+locatorId)}new Mbox($elem,TargetMediator.logger).init()};mboxLast=function(){consoleDebug("Seen mboxLast");TargetMediator.hasEncounteredLastMbox=true;TargetMediator.checkJqueryReadyHold()};var TargetMediator={init:function(options){TargetMediator.scriptLoadTime=(new Date).getTime();if(Util.getQueryStringParameterByName("debugTarget")==="true"){TargetMediator.debug=true}consoleDebug("Script load at time "+TargetMediator.scriptLoadTime);if(!Util.hasCORSSupport()){TargetMediator.preventMboxCreation();consoleDebug("Mboxes not initialized because CORS is not supported");return}TargetMediator.pageLangCode=TargetMediator.determinePageLangCode();if(!(TargetMediator.pageLangCode in TargetMediator.supportedLangs)){TargetMediator.preventMboxCreation();consoleDebug("Mboxes not initialized because the page lang is not supported");return}TargetMediator.hideAllMboxes();$.holdReady(true);TargetMediator.supportedLangsRegExp=TargetMediator.getSupportedLangsRegExp();for(var key in options){if(options.hasOwnProperty(key)){TargetMediator[key]=options[key]}}var parameterFetcher=new ParameterFetcher;parameterFetcher.init();TargetMediator.pageParams=parameterFetcher.allParams();TargetMediator.logger=new Logger},determinePageLangCode:function(){var pageLangCode=$("html").attr("lang");if(typeof pageLangCode==="undefined"){consoleDebug("HTML tag lang attribute is undefined")}return pageLangCode},getSupportedLangsRegExp:function(){var supportedLangs=TargetMediator.supportedLangs;var supportedLangValues=[];var i=0;for(var key in supportedLangs){if(supportedLangs.hasOwnProperty(key)){supportedLangValues[i++]=TargetMediator.supportedLangs[key]}}supportedLangValues.push("ja");return new RegExp("^("+supportedLangValues.join("|")+")_")},hideAllMboxes:function(){document.write("<style>."+"js-mbox"+" { visibility:hidden; }</style>")},preventMboxCreation:function(){mboxCreate=function(){};mboxLast=function(){}},allMboxesResolved:function(){var mboxRegistry=TargetMediator.mboxRegistry;for(var mbox in mboxRegistry){if(mboxRegistry.hasOwnProperty(mbox)){if(mboxRegistry[mbox].state==="pending"){return false}}}return true},releaseJqueryHoldReady:function(){$.holdReady(false);consoleDebug("Release jQuery ready "+"at time "+(new Date).getTime()+"; "+((new Date).getTime()-TargetMediator.scriptLoadTime)+"ms elapsed")},checkJqueryReadyHold:function(){if(TargetMediator.allMboxesResolved()){TargetMediator.releaseJqueryHoldReady()}},debug:false,locatorNodeCount:0,mboxRegistry:{},pageParams:{},pageLangCode:null,supportedLangs:{"en-US":"en","es-ES":"es","de-DE":"de","fr-FR":"fr","ja-JP":"jp","ko-KR":"ko","pt-BR":"pt","ru-RU":"ru","zh-CN":"cn","zh-TW":"tw"},supportedLangsRegExp:null,scriptLoadTime:null,logger:null,hasEncounteredLastMbox:false,isFirstTimeVisitor:false,offerFileSuffix:"/",offerContentPath:"",offerQueryString:""};if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=function(){TargetMediator.Util=Util;TargetMediator.TargetError=TargetError;TargetMediator.Logger=Logger;TargetMediator.TargetRequestDataBuilder=TargetRequestDataBuilder;TargetMediator.CookieManager=CookieManager;TargetMediator.ParameterFetcher=ParameterFetcher;TargetMediator.TargetRequester=TargetRequester;TargetMediator.AWSRequester=AWSRequester;TargetMediator.Mbox=Mbox;return TargetMediator}}if(typeof window==="object"&&typeof window.document==="object"){AWS=typeof AWS!=="undefined"?AWS:{};AWS.TargetMediator=TargetMediator;if(!window.console){console={log:function(){}}}}}();